<!DOCTYPE html>
<html>

  <!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="High-performance dynamic image server in Java
">

  <title>
    Cantaloupe Image Server
    
      :: Delegate Script
    
  </title>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" href="/cantaloupe/css/syntax.css">
  <link rel="stylesheet" href="/cantaloupe/css/manual.css">

  <script src="/cantaloupe/scripts/jquery.min.js"></script>

</head>


  <body>

    <nav class="navbar navbar-expand-md navbar-dark bg-primary">
  <a class="navbar-brand" href="/cantaloupe/">
    <img alt="Cantaloupe" src="/cantaloupe/images/cantaloupe.png" width="40">
  </a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-items" aria-controls="navbar-items" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="navbar-items">
    <ul class="navbar-nav mr-auto">
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle  active " href="#" id="user-manual-dropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          User Manual
        </a>
        <div class="dropdown-menu" aria-labelledby="user-manual-dropdown">
          <a class="dropdown-item" href="/cantaloupe/manual/4.1/getting-started.html">4.1</a>
          <a class="dropdown-item" href="/cantaloupe/manual/4.0/getting-started.html">4.0</a>
          <a class="dropdown-item" href="/cantaloupe/manual/3.4/getting-started.html">3.4</a>
          <a class="dropdown-item" href="/cantaloupe/manual/3.3/getting-started.html">3.3</a>
          <a class="dropdown-item" href="/cantaloupe/manual/3.2/getting-started.html">3.2</a>
          <a class="dropdown-item" href="/cantaloupe/manual/3.1/getting-started.html">3.1</a>
          <a class="dropdown-item" href="/cantaloupe/manual/3.0/getting-started.html">3.0</a>
        </div>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="https://github.com/medusa-project/cantaloupe/">GitHub</a>
      </li>
    </ul>

    <ul class="navbar-nav ml-md-auto">
      <li class="nav-item">
        <a href="https://github.com/medusa-project/cantaloupe/releases.atom" title="Subscribe to Releases">
          <img width="22" height="22" src="/cantaloupe/images/feed.svg">
        </a>
      </li>
    </ul>
  </div>
</nav>


    <div class="container-fluid">
      <div class="row">
  <div class="col-sm-4 col-md-3 col-lg-2 d-print-none">
    <div class="card">
  <h5 class="card-header version">3.3</h5>
  <div class="list-group list-group-flush">
    <a class="list-group-item list-group-item-action " href="getting-started.html">Getting Started</a>

    <a class="list-group-item list-group-item-action " href="configuration.html">Configuration</a>

    <a class="list-group-item list-group-item-action " href="endpoints.html">Endpoints</a>

    <a class="list-group-item list-group-item-action " href="images.html">Images</a>

    <a class="list-group-item list-group-item-action " href="resolvers.html">Resolvers</a>

    <a class="list-group-item list-group-item-action " href="processors.html">Processors</a>

    <a class="list-group-item list-group-item-action " href="caching.html">Caching</a>

    <a class="list-group-item list-group-item-action " href="access-control.html">Access Control</a>

    <a class="list-group-item list-group-item-action " href="metadata.html">Metadata</a>

    <a class="list-group-item list-group-item-action " href="color-profiles.html">Color Profiles</a>

    <a class="list-group-item list-group-item-action " href="overlays.html">Overlays</a>

    <a class="list-group-item list-group-item-action " href="redaction.html">Redaction</a>

    <a class="list-group-item list-group-item-action  active " href="delegate-script.html">Delegate Script</a>

    <a class="list-group-item list-group-item-action " href="logging.html">Logging</a>

    <a class="list-group-item list-group-item-action " href="deployment.html">Deployment</a>

    <a class="list-group-item list-group-item-action " href="remote-management.html">Remote Management</a>
  </div>
</div>

  </div>
  <div class="col-sm-8 col-md-9 col-lg-10">
    <div class="alert alert-primary">
  <i class="fa fa-info-circle"></i>
  This version of the manual refers to an earlier version of the software.
</div>

    <h1>Delegate Script</h1>

<ul>
  <li><a href="#Rules">Rules</a></li>
  <li><a href="#Gems">Gems</a></li>
  <li><a href="#Caching">Caching</a></li>
  <li><a href="#Example">Example</a></li>
  <li><a href="#Testing%20Script%20Methods">Testing Script Methods</a></li>
</ul>

<p>The delegate script mechanism enables the use of custom Ruby methods as "hooks" to provide dynamic information back to the image server. A truly customized image server can be created with minimal code.</p>

<p>Delegate methods are invoked by a JRuby interpreter bundled into the image server. There is no need to install an external Ruby environment and no need to know Java or any of the image server's internal API; just type some code into a file, and go.</p>

<p>Prior to version 3.2, the JRuby interpreter was compatible with Ruby 2.2. Since version 3.2, it has been compatible with version 2.3.</p>

<p>The delegate script mechanism is disabled by default. To enable it, follow these steps:</p>

<ol>
  <li>Copy the sample delegate script, <span class="filename">delegates.rb.sample</span>, included in the distribution, to <span class="filename">delegates.rb</span>.</li>
  <li>Reference it from the <code>delegate_script.pathname</code> configuration option.</li>
  <li>Set <code>delegate_script.enabled</code> to <code>true</code>.</li>
</ol>

<hr>

<h2 id="Rules">Rules</h2>

<p>While the arguments and return types of each method will vary, all delegate methods must be contained within a <code>Cantaloupe</code> module. Inside a method, anything goes, and you can use any (non-platform-native) <a href="#Gems">gems</a> that you have installed with <code>gem install</code>.</p>

<p>Starting in version 3.3, the delegate script is reloaded whenever the script file changes. (Previously, it was reloaded on each request.) Be aware, though, that code that has already been loaded into the JRuby runtime cannot be unloaded. For example, when a method is changed, the new version will overwrite the old version; but constants cannot be redefined.</p>

<p>Because delegate methods will be called frequently, they should be written with efficiency in mind.</p>

<div class="alert alert-danger">Note: generally, neither method arguments nor return values are sanitized or validated. <strong>Be very careful to write defensive, injection-aware code.</strong></div>

<h2 id="Gems">Gems</h2>

<p>JRuby can load most Ruby gems, except those that have been built with native extensions. To import a gem, use the <code>require</code> statement:</p>

<pre>require 'mygem'</pre>

<p><code>require</code> searches for gems based on the <code>$GEM_PATH</code> environment variable, falling back to <code>$GEM_HOME</code> if that is not defined. If JRuby fails to find your gem, check your <code>$GEM_PATH</code>. If you installed the gem using <code>gem install</code>, check the output of <code>gem env</code> (particularly the "gem paths" section) to see where it might have been installed, and ensure that those locations are present in <code>$GEM_PATH</code>.</p>

<h2 id="Caching">Caching</h2>

<p>Since version 3.3, the <code>delegate_script.cache.enabled</code> option is available to cache the results of delegate method invocations. The cache is an in-memory least-recently-used (LRU) cache with infinite time-to-live and a maximum size auto-computed based on the maximum JVM heap size. When the limit is approached, the oldest invocations will be purged automatically.</p>

<p>Because the cache is in memory and not persisted, it will be cleared when the application is stopped.</p>

<p>Note that cached invocations are <strong>not</strong> purged when the script file is edited and auto-reloaded.</p>

<hr>

<h2 id="Example">Example</h2>

<p>Here is an example of a script used by <a href="resolvers.html#FilesystemResolver">FilesystemResolver</a> that performs a Solr query to return a pathname based on an identifier. The documentation in that section describes the contract that this method must abide by: its name, arguments, and return value.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">'cgi'</span>
<span class="nb">require</span> <span class="s1">'net/http'</span>

<span class="k">module</span> <span class="nn">Cantaloupe</span>

  <span class="k">module</span> <span class="nn">FilesystemResolver</span>
    <span class="c1">##</span>
    <span class="c1"># Used by FilesystemResolver's ScriptLookupStrategy.</span>
    <span class="c1">#</span>
    <span class="c1"># @param identifier [String] Image identifier</span>
    <span class="c1"># @return [String,nil] Absolute pathname of the image corresponding to the</span>
    <span class="c1">#                      given identifier, or nil if not found.</span>
    <span class="c1">#</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">get_pathname</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
      <span class="n">uri</span> <span class="o">=</span> <span class="s1">'http://localhost:8983/solr/collection1/select?q='</span> <span class="o">+</span>
          <span class="no">CGI</span><span class="p">.</span><span class="nf">escape</span><span class="p">(</span><span class="s1">'id:"'</span> <span class="o">+</span> <span class="n">identifier</span> <span class="o">+</span> <span class="s1">'"'</span><span class="p">)</span> <span class="o">+</span>
          <span class="s1">'&amp;amp;fl=pathname_si&amp;amp;wt=ruby'</span>
      <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>

      <span class="n">http</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">uri</span><span class="p">.</span><span class="nf">host</span><span class="p">,</span> <span class="n">uri</span><span class="p">.</span><span class="nf">port</span><span class="p">)</span>
      <span class="n">request</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">::</span><span class="no">Get</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">uri</span><span class="p">.</span><span class="nf">request_uri</span><span class="p">)</span>
      <span class="n">response</span> <span class="o">=</span> <span class="n">http</span><span class="p">.</span><span class="nf">request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
      <span class="k">return</span> <span class="kp">nil</span> <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="nf">code</span><span class="p">.</span><span class="nf">to_i</span> <span class="o">&gt;=</span> <span class="mi">400</span>

      <span class="n">results</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">)[</span><span class="s1">'response'</span><span class="p">][</span><span class="s1">'docs'</span><span class="p">]</span>
      <span class="n">results</span><span class="p">.</span><span class="nf">any?</span> <span class="p">?</span> <span class="n">results</span><span class="p">.</span><span class="nf">first</span><span class="p">[</span><span class="s1">'pathname_si'</span><span class="p">]</span> <span class="p">:</span> <span class="kp">nil</span>
    <span class="k">end</span>
  <span class="k">end</span>

<span class="k">end</span></code></pre></figure>

<hr>

<h2 id="Testing Script Methods">Testing Script Methods</h2>

<p>Using the example above, <code>get_pathname()</code> could be tested by adding the following line to the end of the script:

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">puts</span> <span class="no">Cantaloupe</span><span class="o">::</span><span class="no">FilesystemResolver</span><span class="o">::</span><span class="n">get_pathname</span><span class="p">(</span><span class="s1">'identifier-to-test'</span><span class="p">)</span></code></pre></figure>

And running it on the command line with a command like: <code>ruby delegates.rb</code>. The method output will appear in the console.</p>

<p>A catch, however, is that the <code>ruby</code> command will normally invoke the standard ("MRI") Ruby interpreter, and not the JRuby interpreter. While they mostly work the same, one thing to be aware of is that <em>gems with platform-native extensions will not work in JRuby</em>. For that reason, you might want to install a standalone <a href="http://jruby.org">JRuby interpreter</a> and test with that instead. (Something like <a href="http://rvm.io/">RVM</a> can make it easier to switch between different versions of the Ruby interpreter.)</p>

  </div>
</div>


      <footer>
</footer>

<script src="/cantaloupe/scripts/bootstrap.min.js"></script>
<script src="/cantaloupe/scripts/base.js"></script>

    </div>

  </body>

</html>
