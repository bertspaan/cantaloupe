<!DOCTYPE html>
<html>

  <!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="High-performance dynamic image server in Java
">

  <title>
    Cantaloupe Image Server
    
      :: Resolvers
    
  </title>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" href="/cantaloupe/css/syntax.css">
  <link rel="stylesheet" href="/cantaloupe/css/manual.css">

  <script src="/cantaloupe/scripts/jquery.min.js"></script>

</head>


  <body>

    <nav class="navbar navbar-expand-md navbar-dark bg-primary">
  <a class="navbar-brand" href="/cantaloupe/">
    <img alt="Cantaloupe" src="/cantaloupe/images/cantaloupe.png" width="40">
  </a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-items" aria-controls="navbar-items" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="navbar-items">
    <ul class="navbar-nav mr-auto">
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle  active " href="#" id="user-manual-dropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          User Manual
        </a>
        <div class="dropdown-menu" aria-labelledby="user-manual-dropdown">
          <a class="dropdown-item" href="/cantaloupe/manual/4.1/getting-started.html">4.1</a>
          <a class="dropdown-item" href="/cantaloupe/manual/4.0/getting-started.html">4.0</a>
          <a class="dropdown-item" href="/cantaloupe/manual/3.4/getting-started.html">3.4</a>
          <a class="dropdown-item" href="/cantaloupe/manual/3.3/getting-started.html">3.3</a>
          <a class="dropdown-item" href="/cantaloupe/manual/3.2/getting-started.html">3.2</a>
          <a class="dropdown-item" href="/cantaloupe/manual/3.1/getting-started.html">3.1</a>
          <a class="dropdown-item" href="/cantaloupe/manual/3.0/getting-started.html">3.0</a>
        </div>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="https://github.com/medusa-project/cantaloupe/">GitHub</a>
      </li>
    </ul>

    <ul class="navbar-nav ml-md-auto">
      <li class="nav-item">
        <a href="https://github.com/medusa-project/cantaloupe/releases.atom" title="Subscribe to Releases">
          <img width="22" height="22" src="/cantaloupe/images/feed.svg">
        </a>
      </li>
    </ul>
  </div>
</nav>


    <div class="container-fluid">
      <div class="row">
  <div class="col-sm-4 col-md-3 col-lg-2 d-print-none">
    <div class="card">
  <h5 class="card-header version">3.3</h5>
  <div class="list-group list-group-flush">
    <a class="list-group-item list-group-item-action " href="getting-started.html">Getting Started</a>

    <a class="list-group-item list-group-item-action " href="configuration.html">Configuration</a>

    <a class="list-group-item list-group-item-action " href="endpoints.html">Endpoints</a>

    <a class="list-group-item list-group-item-action " href="images.html">Images</a>

    <a class="list-group-item list-group-item-action  active " href="resolvers.html">Resolvers</a>

    <a class="list-group-item list-group-item-action " href="processors.html">Processors</a>

    <a class="list-group-item list-group-item-action " href="caching.html">Caching</a>

    <a class="list-group-item list-group-item-action " href="access-control.html">Access Control</a>

    <a class="list-group-item list-group-item-action " href="metadata.html">Metadata</a>

    <a class="list-group-item list-group-item-action " href="color-profiles.html">Color Profiles</a>

    <a class="list-group-item list-group-item-action " href="overlays.html">Overlays</a>

    <a class="list-group-item list-group-item-action " href="redaction.html">Redaction</a>

    <a class="list-group-item list-group-item-action " href="delegate-script.html">Delegate Script</a>

    <a class="list-group-item list-group-item-action " href="logging.html">Logging</a>

    <a class="list-group-item list-group-item-action " href="deployment.html">Deployment</a>

    <a class="list-group-item list-group-item-action " href="remote-management.html">Remote Management</a>
  </div>
</div>

  </div>
  <div class="col-sm-8 col-md-9 col-lg-10">
    <div class="alert alert-primary">
  <i class="fa fa-info-circle"></i>
  This version of the manual refers to an earlier version of the software.
</div>

    <h1>Resolvers</h1>

<ul>
  <li><a href="#Selection">Selection</a>
    <ul>
      <li><a href="#Static%20Resolver">Static</a></li>
      <li><a href="#Dynamic%20Resolvers">Dynamic</a></li>
      <li><a href="#Which%20Resolver%20Should%20I%20Use">Which Resolver Should I Use?</a></li>
    </ul>
  </li>
  <li><a href="#Implementations">Implementations</a>
    <ul>
      <li><a href="#FilesystemResolver">FilesystemResolver</a></li>
      <li><a href="#HttpResolver">HttpResolver</a></li>
      <li><a href="#JdbcResolver">JdbcResolver</a></li>
      <li><a href="#AmazonS3Resolver">AmazonS3Resolver</a></li>
      <li><a href="#AzureStorageResolver">AzureStorageResolver</a></li>
    </ul>
  </li>
</ul>

<p>Resolvers locate and provide access to source images. A resolver translates an identifier in a request URL to an image locator, such as a pathname, in the particular type of underlying storage it is written to interface with. It can then check whether the underlying object exists and is accessible, and if so, provide access to it to other image server components. The rest of the image server does not need to know where an image resides, be it on the filesystem, in a database, on a remote web server, or in cloud storage&mdash;it can simply ask the current resolver, whatever it may be, to provide a generic interface from which an image can be read.</p>

<p>The interface in question may be a stream or a file. All resolvers can provide stream access, but only <a href="#FilesystemResolver">FilesystemResolver</a> can provide file access. This distinction is important because <a href="processors.html#Resolver%20Compatibility">not all processors can read from streams</a>.</p>

<h2 id="Selection">Selection</h2>

<p>In a typical configuration, <a href="#Static%20Resolver">one resolver will handle all requests</a>. It is also possible to configure the image server to <a href="#Dynamic%20Resolvers">select a resolver dynamically</a> upon each request depending on the image identifier.</p>

<h3 id="Static Resolver">Static Resolver</h2>

<p>When the <code>resolver.static</code> configuration key is set to the name of a resolver, that resolver will be used for all requests.</p>

<h3 id="Dynamic Resolvers">Dynamic Resolvers</h2>

<p>When a static resolver is not flexible enough, it is also possible to serve images from different sources simultaneously. For example, you may have some images stored on a filesystem, and others stored on Amazon S3. <em>If you can differentiate their sources based on their identifier in code</em>&mdash;either by analyzing the identifier string, or performing some kind of service request&mdash;you can use the <a href="delegate-script.html">delegate script</a> mechanism to write a simple Ruby method to tell the image server which resolver to use for a given request.</p>

<p>To enable dynamic resolver selection, set the <code>resolver.delegate</code> configuration key to <code>true</code>. Then, implement the <code>get_resolver(identifier)</code> method in the delegate script, which takes in an identifier and returns a resolver name (like FilesystemResolver, HttpResolver, etc.) For example:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Cantaloupe</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">get_resolver</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
    <span class="c1"># Here, you would perform some kind of analysis on `identifier`:</span>
    <span class="c1"># parse it, look it up in a web service or database...</span>
    <span class="c1"># and then return the name of the resolver to use to serve it.</span>
    <span class="s1">'FilesystemResolver'</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>See the <a href="delegate-script.html">Delegate Script</a> section for general information about the delegate script.</p>

<h3 id="Which Resolver Should I Use">Which Resolver Should I Use?</h3>

<table class="table table-bordered">
  <caption>I want to serve images located&hellip;</caption>
  <tr>
    <td rowspan="2">On a filesystem&hellip;</td>
    <td>&hellip;and the identifiers I use in URLs will correspond predictably to filesystem paths</td>
    <td><a href="#FilesystemResolver">FilesystemResolver</a> with BasicLookupStrategy</td>
  </tr>
  <tr>
    <td>&hellip;and filesystem paths will need to be looked up (in a SQL database, search server, index file, etc.) based on their identifier</td>
    <td><a href="#FilesystemResolver">FilesystemResolver</a> with ScriptLookupStrategy</td>
  </tr>
  <tr>
    <td rowspan="2">On a local or remote web server&hellip;</td>
    <td>&hellip;and the identifiers I use in URLs will correspond predictably to URL paths</td>
    <td><a href="#HttpResolver">HttpResolver</a> with BasicLookupStrategy</td>
  </tr>
  <tr>
    <td>&hellip;and URL paths will need to be looked up (in a SQL database, search server, index file, etc.) based on their identifier</td>
    <td><a href="#HttpResolver">HttpResolver</a> with ScriptLookupStrategy</td>
  </tr>
  <tr>
    <td colspan="2">As binaries or BLOBs in a SQL database</td>
    <td><a href="#JdbcResolver">JdbcResolver</a></td>
  </tr>
  <tr>
    <td colspan="2">In the cloud</td>
    <td><a href="#AmazonS3Resolver">AmazonS3Resolver</a> or <a href="#AzureStorageResolver">AzureStorageResolver</a></td>
  </tr>
</table>

<h2 id="Implementations">Implementations</h2>

<h3 id="FilesystemResolver">FilesystemResolver</h3>

<p>FilesystemResolver maps a URL identifier to a filesystem path, for retrieving images on a local or attached filesystem. In addition to being the most compatible resolver, <strong>this is also the most efficient resolver</strong> and may or may not be the only option for serving very large source images.</p>

<p>For images with extensions that are missing or unrecognized, this resolver will check the "magic number" to determine type, which will add some overhead. It is therefore slightly more efficient to serve images with extensions.</p>

<p>FilesystemResolver supports two distinct lookup strategies, defined by the <code>FilesystemResolver.lookup_strategy</code> configuration option.</p>

<h4 id="FilesystemResolverBasicLookupStrategy">BasicLookupStrategy</h4>

<p>BasicLookupStrategy locates images by concatenating a pre-defined path prefix and/or suffix. For example, with the following configuration options set:</p>

<figure class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="c"># Note trailing slash!
</span><span class="py">FilesystemResolver.BasicLookupStrategy.path_prefix</span> <span class="p">=</span> <span class="s">/usr/local/images/</span>
<span class="py">FilesystemResolver.BasicLookupStrategy.path_suffix</span> <span class="p">=</span></code></pre></figure>

<p>An identifier of <code>image.jpg</code> in the URL will resolve to
<span class="filename">/usr/local/images/image.jpg</span>.</p>

<p>It's also possible to include a partial path in the identifier using URL-encoded slashes (<code>%2F</code>) as path separators. <code>subdirectory%2Fimage.jpg</code> in the URL would then resolve to <span class="filename">/usr/local/images/subdirectory/image.jpg</span>.</p>

<div class="alert alert-info">If you are operating behind a reverse proxy that is not capable of passing encoded URL characters through without decoding them, see the <code>slash_substitude</code> configuration key.</div>

<p>To prevent arbitrary directory traversal, BasicLookupStrategy will strip out <code>..{path separator}</code> and <code>{path separator}..</code> from identifiers before resolving the path.</p>

<div class="alert alert-danger">Note: it may be dangerous to <strong>not</strong> use <code>path_prefix</code>. The shallower the path, the more of the filesystem that will be exposed.</div>

<h4 id="FilesystemResolverScriptLookupStrategy">ScriptLookupStrategy</h4>

<p>Sometimes, BasicLookupStrategy will not offer enough control. Perhaps you want to serve images from multiple filesystems, or perhaps your identifiers are opaque and you need to perform a database or web service request to locate the corresponding images. With this lookup strategy, you can tell FilesystemResolver to invoke a method in your <a href="delegate-script.html">delegate script</a> and capture the pathname it returns.</p>

<p>The delegate script method, <code>get_pathname(identifier)</code>, will take in an identifier string and should return a pathname, if available, or <code>nil</code>, if not. (See the <a href="delegate-script.html">Delegate Script</a> section for general information about the delegate script.) Examples follow:</p>

<h5>Example 1: Query a PostgreSQL database to find the pathname corresponding to a given identifier</h5>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">'java'</span>

<span class="n">java_import</span> <span class="s1">'org.postgresql.Driver'</span>
<span class="n">java_import</span> <span class="s1">'java.sql.DriverManager'</span>

<span class="k">module</span> <span class="nn">Cantaloupe</span>
  <span class="k">module</span> <span class="nn">FilesystemResolver</span>
    <span class="no">JDBC_URL</span> <span class="o">=</span> <span class="s1">'jdbc:postgresql://localhost:5432/mydatabase'</span>
    <span class="no">JDBC_USER</span> <span class="o">=</span> <span class="s1">'myuser'</span>
    <span class="no">JDBC_PASSWORD</span> <span class="o">=</span> <span class="s1">'mypassword'</span>

    <span class="c1"># DriverManager is actually java.sql.DriverManager</span>
    <span class="c1"># (https://docs.oracle.com/javase/8/docs/api/java/sql/DriverManager.html);</span>
    <span class="c1"># we are calling Java API via JRuby.</span>
    <span class="c1"># By making the connection static, we can avoid reconnecting every time</span>
    <span class="c1"># get_pathname() is called, which would be slow and expensive.</span>
    <span class="vc">@@conn</span> <span class="o">=</span> <span class="no">DriverManager</span><span class="p">.</span><span class="nf">get_connection</span><span class="p">(</span><span class="no">JDBC_URL</span><span class="p">,</span> <span class="no">JDBC_USER</span><span class="p">,</span> <span class="no">JDBC_PASSWORD</span><span class="p">)</span>

    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">get_pathname</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
      <span class="k">begin</span>
        <span class="c1"># Note the use of prepared statements to prevent SQL injection.</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s1">'SELECT pathname FROM images WHERE identifier = ? LIMIT 1'</span>
        <span class="n">stmt</span> <span class="o">=</span> <span class="vc">@@conn</span><span class="p">.</span><span class="nf">prepare_statement</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="n">stmt</span><span class="p">.</span><span class="nf">set_string</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">identifier</span><span class="p">.</span><span class="nf">to_s</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">stmt</span><span class="p">.</span><span class="nf">execute_query</span>
        <span class="n">results</span><span class="p">.</span><span class="nf">next</span>
        <span class="n">pathname</span> <span class="o">=</span> <span class="n">results</span><span class="p">.</span><span class="nf">getString</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">pathname</span><span class="p">.</span><span class="nf">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">?</span> <span class="n">pathname</span> <span class="p">:</span> <span class="kp">nil</span>
      <span class="k">ensure</span>
        <span class="n">stmt</span><span class="p">.</span><span class="nf">close</span> <span class="k">if</span> <span class="n">stmt</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>Note that several common Ruby database libraries (like the mysql and pgsql gems) use native extensions. These won't work in JRuby. Instead, the course of action above is to use the JDBC API via the JRuby-Java bridge. For this to work, a JDBC driver for your database will need to be installed on the Java classpath, and referenced in a <code>java_import</code> statement.</p>

<h5>Example 2: Query a web service to find the pathname corresponding to a given identifier</h5>

<p>This very simple imaginary web service will return a pathname in the response body if an image was found, and an empty response body if not.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">'net/http'</span>
<span class="nb">require</span> <span class="s1">'cgi'</span>

<span class="k">module</span> <span class="nn">Cantaloupe</span>
  <span class="k">module</span> <span class="nn">FilesystemResolver</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">get_pathname</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
      <span class="n">uri</span> <span class="o">=</span> <span class="s1">'http://example.org/webservice/'</span> <span class="o">+</span> <span class="no">CGI</span><span class="p">.</span><span class="nf">escape</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
      <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>

      <span class="n">http</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">uri</span><span class="p">.</span><span class="nf">host</span><span class="p">,</span> <span class="n">uri</span><span class="p">.</span><span class="nf">port</span><span class="p">)</span>
      <span class="n">request</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">::</span><span class="no">Get</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">uri</span><span class="p">.</span><span class="nf">request_uri</span><span class="p">)</span>
      <span class="n">response</span> <span class="o">=</span> <span class="n">http</span><span class="p">.</span><span class="nf">request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
      <span class="k">return</span> <span class="kp">nil</span> <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="nf">code</span><span class="p">.</span><span class="nf">to_i</span> <span class="o">&gt;=</span> <span class="mi">400</span>

      <span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">?</span> <span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">strip</span> <span class="p">:</span> <span class="kp">nil</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<h5>Example 3: Query Solr to find the pathname corresponding to a given identifier</h5>

<p>In this variation on the previous example, our web service is Solr, and instead of parsing a text string out of the response body, we treat the body as Ruby code.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">'net/http'</span>
<span class="nb">require</span> <span class="s1">'cgi'</span>

<span class="k">module</span> <span class="nn">Cantaloupe</span>
  <span class="k">module</span> <span class="nn">FilesystemResolver</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">get_pathname</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
      <span class="n">uri</span> <span class="o">=</span> <span class="s1">'http://localhost:8983/solr/collection1/select?q='</span> <span class="o">+</span>
          <span class="no">CGI</span><span class="p">.</span><span class="nf">escape</span><span class="p">(</span><span class="s1">'id:"'</span> <span class="o">+</span> <span class="n">identifier</span> <span class="o">+</span> <span class="s1">'"'</span><span class="p">)</span> <span class="o">+</span>
          <span class="s1">'&amp;amp;fl=pathname_si&amp;amp;wt=ruby'</span>
      <span class="n">uri</span> <span class="o">=</span> <span class="no">URI</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>

      <span class="n">http</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">uri</span><span class="p">.</span><span class="nf">host</span><span class="p">,</span> <span class="n">uri</span><span class="p">.</span><span class="nf">port</span><span class="p">)</span>
      <span class="n">request</span> <span class="o">=</span> <span class="no">Net</span><span class="o">::</span><span class="no">HTTP</span><span class="o">::</span><span class="no">Get</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">uri</span><span class="p">.</span><span class="nf">request_uri</span><span class="p">)</span>
      <span class="n">response</span> <span class="o">=</span> <span class="n">http</span><span class="p">.</span><span class="nf">request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
      <span class="k">return</span> <span class="kp">nil</span> <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="nf">code</span><span class="p">.</span><span class="nf">to_i</span> <span class="o">&gt;=</span> <span class="mi">400</span>

      <span class="n">results</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">body</span><span class="p">)[</span><span class="s1">'response'</span><span class="p">][</span><span class="s1">'docs'</span><span class="p">]</span>
      <span class="n">results</span><span class="p">.</span><span class="nf">any?</span> <span class="p">?</span> <span class="n">results</span><span class="p">.</span><span class="nf">first</span><span class="p">[</span><span class="s1">'pathname_si'</span><span class="p">]</span> <span class="p">:</span> <span class="kp">nil</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<hr>

<h3 id="HttpResolver">HttpResolver</h3>

<p>HttpResolver maps a URL identifier to an HTTP or HTTPS resource, for retrieving images from a web server.</p>

<p>It is preferable to use this resolver with source images with recognizable file extensions. For images with an extension that is missing or unrecognizable, it will issue an HTTP HEAD request to the server to check the <code>Content-Type</code> header. If the type cannot be inferred from that, an error response will be returned.</p>

<p>HttpResolver supports two distinct lookup strategies, defined by the <code>HttpResolver.lookup_strategy</code> configuration option.</p>

<h4 id="HttpResolverBasicLookupStrategy">BasicLookupStrategy</h4>

<p>BasicLookupStrategy locates images by concatenating a pre-defined URL prefix and/or suffix. For example, with the following configuration options set:</p>

<figure class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="c"># Note trailing slash!
</span><span class="py">HttpResolver.url_prefix</span> <span class="p">=</span> <span class="s">http://example.org/images/</span>
<span class="py">HttpResolver.url_suffix</span> <span class="p">=</span></code></pre></figure>

<p>An identifier of <code>image.jpg</code> in the URL will resolve to
<span class="filename">http://example.org/images/image.jpg</span>.

<p>It's also possible to include a partial path in the identifier using URL-encoded slashes (<code>%2F</code>) as path separators. <code>subdirectory%2Fimage.jpg</code> in the URL would then resolve to <span class="filename">http://example.org/images/subdirectory/image.jpg</span>.</p>

<div class="alert alert-info">If you are operating behind a reverse proxy that is not capable of passing encoded URL characters through without decoding them, see the <code>slash_substitude</code> configuration key.</div>

<h4 id="HttpResolverScriptLookupStrategy">ScriptLookupStrategy</h4>

<p>Sometimes, BasicLookupStrategy will not offer enough control. Perhaps you want to serve images from multiple URLs, or perhaps your identifiers are opaque and you need to run a database or web service request to locate them.  With this lookup strategy, you can tell HttpResolver to invoke a method in your <a href="delegate-script.html">delegate script</a> and capture the URL it returns.</p>

<p>The delegate script method, <code>get_url(identifier)</code>, will take in an identifier string and should return a URL, if available, or <code>nil</code>, if not. See the <a href="delegate-script.html">Delegate Script</a> section for general information about the delegate script, and the <a href="#FilesystemResolverScriptLookupStrategy">FilesystemResolver ScriptLookupStrategy</a> section for examples of similar scripts.</p>

<hr>

<h3 id="JdbcResolver">JdbcResolver</h3>

<p>JdbcResolver maps a URL identifier to an RDBMS BLOB field, for retrieving images from a relational database. It does not require a custom schema and can adapt to any schema. The downside of that is that some <a href="delegate-script.html">delegate script</a> methods must be implemented in order to obtain the information needed to run the SQL queries.</p>

<p>Cantaloupe does not include any JDBC drivers, so a driver JAR for the desired database must be obtained separately and saved somewhere on the classpath.</p>

<p>The JDBC connection is initialized by the <code>JdbcResolver.url</code>, <code>JdbcResolver.user</code>, and <code>JdbcResolver.password</code> configuration options. If the user or password are not necessary, they can be left blank. The connection string must use your driver's JDBC syntax:</p>

<pre><code>jdbc:postgresql://localhost:5432/my_database
jdbc:mysql://localhost:3306/my_database
jdbc:microsoft:sqlserver://example.org:1433;DatabaseName=MY_DATABASE</code></pre>

<p>Consult the driver's documentation for details.</p>

<p>Then, the resolver needs to be told:</p>

<ol>
  <li><a href="#JdbcResolverIdentifierMethod">The database value corresponding to a given identifier</a></li>
  <li><a href="#JdbcResolverMediaTypeMethod">The media type corresponding to that value</a></li>
  <li><a href="#JdbcResolverBlobSQLMethod">The SQL statement that retrieves the BLOB value corresponding to that value</a></li>
</ol>

<h4 id="JdbcResolverIdentifierMethod">Database Identifier Retrieval Method</h4>

<p>This method takes in an unencoded URL identifier and returns the corresponding database value of the identifier.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Cantaloupe</span>
  <span class="k">module</span> <span class="nn">JdbcResolver</span>
    <span class="n">get_database_identifier</span><span class="p">(</span><span class="n">url_identifier</span><span class="p">)</span>
      <span class="c1"># If URL identifiers map directly to values in the database, simply</span>
      <span class="c1"># return url_identifier. Otherwise, you could transform it, perform</span>
      <span class="c1"># a service request to look it up, etc.</span>
      <span class="n">url_identifier</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<h4 id="JdbcResolverMediaTypeMethod">Media Type Retrieval Method</h4>

<p>This method returns a media (MIME) type corresponding to the value returned by the <code><a href="#JdbcResolverIdentifierMethod">get_database_identifier</a></code> method. If the media type is stored in the database, this example will return an SQL statement to retrieve it.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Cantaloupe</span>
  <span class="k">module</span> <span class="nn">JdbcResolver</span>
    <span class="k">def</span> <span class="nf">get_media_type</span>
      <span class="s1">'SELECT media_type '</span> <span class="o">+</span>
          <span class="s1">'FROM some_table '</span> <span class="o">+</span>
          <span class="s1">'WHERE some_identifier = ?'</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>If the URL identifier will <strong>always</strong> have a known, valid image extension, like <span class="filename">.jpg</span>, <span class="filename">.tif</span>, etc., this method can return <code>nil</code>, and Cantaloupe will infer the media type from the extension.</p>

<h4 id="JdbcResolverBlobSQLMethod">BLOB Retrieval SQL Method</h4>

<p>The <code>get_lookup_sql</code> method returns an SQL statement that selects the BLOB value corresponding to the value returned by the <code><a href="#JdbcResolverIdentifierMethod">get_database_identifier</a></code> method.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Cantaloupe</span>
  <span class="k">module</span> <span class="nn">JdbcResolver</span>
    <span class="k">def</span> <span class="nf">get_lookup_sql</span>
      <span class="s1">'SELECT image_blob_column '</span>
          <span class="s1">'FROM some_table '</span>
          <span class="s1">'WHERE some_identifier = ?'</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<hr>

<h3 id="AmazonS3Resolver">AmazonS3Resolver</h3>

<p>AmazonS3Resolver maps a URL identifier to an <a href="https://aws.amazon.com/s3/">Amazon Simple Storage Service (S3)</a> object, for retrieving images from Amazon S3. It can be configured with the following options:</p>

<dl>
  <dt><code>AmazonS3Resolver.access_key_id</code></dt>
  <dd>An access key associated with your AWS account. (See <a href="http://aws.amazon.com/security-credentials">AWS Security Credentials</a>.)</dd>
  <dt><code>AmazonS3Resolver.secret_key</code></dt>
  <dd>A secret key associated with your AWS account. (See <a href="http://aws.amazon.com/security-credentials">AWS Security Credentials</a>.)</dd>
  <dt><code>AmazonS3Resolver.bucket.name</code></dt>
  <dd>Name of the bucket containing the images to be served.</dd>
  <dt><code>AmazonS3Resolver.bucket.region</code></dt>
  <dd>Name of a region to send requests to, such as <code>us-east-1</code>. Can be commented out or left blank to use a default region. (See <a href="https://docs.aws.amazon.com/general/latest/gr/rande.html#s3_region">S3 Regions</a>.)</dd>
  <dt><code>AmazonS3Resolver.lookup_strategy</code></dt>
  <dd>The strategy to use to look up images based on their URL identifier. See below.</dd>
</dl>

<h4 id="AmazonS3ResolverBasicLookupStrategy">BasicLookupStrategy</h4>

<p>BasicLookupStrategy locates images by passing the URL identifier as-is to S3, with no additional configuration necessary or possible.</p>

<h4 id="AmazonS3ResolverScriptLookupStrategy">ScriptLookupStrategy</h4>

<p>When your URL identifiers don't match your Amazon S3 object keys, ScriptLookupStrategy is available to tell AmazonS3Resolver to capture the object key returned by a method in your <a href="delegate-script.html">delegate script</a>.</p>

<p>The delegate script method, <code>get_s3_object_key(identifier)</code>, will take in an identifier string and should return an S3 object key string, if available, or <code>nil</code>, if not. See the <a href="delegate-script.html">Delegate Script</a> section for general information about the delegate script, and the <a href="#FilesystemResolverScriptLookupStrategy">FilesystemResolver ScriptLookupStrategy</a> section for an example of a similar script.</p>

<hr>

<h3 id="AzureStorageResolver">AzureStorageResolver</h3>

<p>AzureStorageResolver maps a URL identifier to a <a href="https://azure.microsoft.com/en-us/services/storage/">Microsoft Azure Storage</a> blob, for retrieving images from Azure Storage. It can be configured with the following options:</p>

<dl>
  <dt><code>AzureStorageResolver.account_name</code></dt>
  <dd>The name of your Azure account.</dd>
  <dt><code>AzureStorageResolver.account_key</code></dt>
  <dd>A key to access your Azure Storage account.</dd>
  <dt><code>AzureStorageResolver.container_name</code></dt>
  <dd>Name of the container from which to serve images.</dd>
  <dt><code>AzureStorageResolver.lookup_strategy</code></dt>
  <dd>The strategy to use to look up images based on their URL identifier. See below.</dd>
</dl>

<h4 id="AzureStorageResolverBasicLookupStrategy">BasicLookupStrategy</h4>

<p>BasicLookupStrategy locates images by passing the URL identifier as-is to Azure Storage, with no additional configuration necessary or possible.</p>

<h4 id="AzureStorageResolverScriptLookupStrategy">ScriptLookupStrategy</h4>

<p>When your URL identifiers don't match your Azure Storage blob keys, ScriptLookupStrategy is available to tell AzureStorageResolver to capture the blob key returned by a method in your <a href="delegate-script.html">delegate script</a>.</p>

<p>The delegate script method, <code>get_azure_storage_blob_key(identifier)</code>, will take in an identifier string and should return a blob key string, if available, or <code>nil</code>, if not. See the <a href="delegate-script.html">Delegate Script</a> section for general information about the delegate script, and the <a href="#FilesystemResolverScriptLookupStrategy">FilesystemResolver ScriptLookupStrategy</a> section for an example of a similar script.</p>

  </div>
</div>


      <footer>
</footer>

<script src="/cantaloupe/scripts/bootstrap.min.js"></script>
<script src="/cantaloupe/scripts/base.js"></script>

    </div>

  </body>

</html>
