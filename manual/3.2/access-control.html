<!DOCTYPE html>
<html>

  <!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="High-performance dynamic image server in Java
">

  <title>
    Cantaloupe Image Server
    
      :: Access Control
    
  </title>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" href="/cantaloupe/css/syntax.css">
  <link rel="stylesheet" href="/cantaloupe/css/manual.css">

  <script src="/cantaloupe/scripts/jquery.min.js"></script>

</head>


  <body>

    <nav class="navbar navbar-expand-md navbar-dark bg-primary">
  <a class="navbar-brand" href="/cantaloupe/">
    <img alt="Cantaloupe" src="/cantaloupe/images/cantaloupe.png" width="40">
  </a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-items" aria-controls="navbar-items" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="navbar-items">
    <ul class="navbar-nav mr-auto">
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle  active " href="#" id="user-manual-dropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          User Manual
        </a>
        <div class="dropdown-menu" aria-labelledby="user-manual-dropdown">
          <a class="dropdown-item" href="/cantaloupe/manual/4.1/getting-started.html">4.1</a>
          <a class="dropdown-item" href="/cantaloupe/manual/4.0/getting-started.html">4.0</a>
          <a class="dropdown-item" href="/cantaloupe/manual/3.4/getting-started.html">3.4</a>
          <a class="dropdown-item" href="/cantaloupe/manual/3.3/getting-started.html">3.3</a>
          <a class="dropdown-item" href="/cantaloupe/manual/3.2/getting-started.html">3.2</a>
          <a class="dropdown-item" href="/cantaloupe/manual/3.1/getting-started.html">3.1</a>
          <a class="dropdown-item" href="/cantaloupe/manual/3.0/getting-started.html">3.0</a>
        </div>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="https://github.com/medusa-project/cantaloupe/">GitHub</a>
      </li>
    </ul>

    <ul class="navbar-nav ml-md-auto">
      <li class="nav-item">
        <a href="https://github.com/medusa-project/cantaloupe/releases.atom" title="Subscribe to Releases">
          <img width="22" height="22" src="/cantaloupe/images/feed.svg">
        </a>
      </li>
    </ul>
  </div>
</nav>


    <div class="container-fluid">
      <div class="row">
  <div class="col-sm-4 col-md-3 col-lg-2 d-print-none">
    <div class="card">
  <h5 class="card-header version">3.2</h5>
  <div class="list-group list-group-flush">
    <a class="list-group-item list-group-item-action " href="getting-started.html">Getting Started</a>

    <a class="list-group-item list-group-item-action " href="endpoints.html">Endpoints</a>

    <a class="list-group-item list-group-item-action " href="images.html">Images</a>

    <a class="list-group-item list-group-item-action " href="resolvers.html">Resolvers</a>

    <a class="list-group-item list-group-item-action " href="processors.html">Processors</a>

    <a class="list-group-item list-group-item-action " href="caching.html">Caching</a>

    <a class="list-group-item list-group-item-action  active " href="access-control.html">Access Control</a>

    <a class="list-group-item list-group-item-action " href="metadata.html">Metadata</a>

    <a class="list-group-item list-group-item-action " href="color-profiles.html">Color Profiles</a>

    <a class="list-group-item list-group-item-action " href="watermarking.html">Watermarking</a>

    <a class="list-group-item list-group-item-action " href="redaction.html">Redaction</a>

    <a class="list-group-item list-group-item-action " href="delegate-script.html">Delegate Script</a>

    <a class="list-group-item list-group-item-action " href="logging.html">Logging</a>

    <a class="list-group-item list-group-item-action " href="deployment.html">Deployment</a>
  </div>
</div>

  </div>
  <div class="col-sm-8 col-md-9 col-lg-10">
    <div class="alert alert-primary">
  <i class="fa fa-info-circle"></i>
  This version of the manual refers to an earlier version of the software.
</div>

    <h1>Access Control</h1>

<ul>
  <li><a href="#Authentication">Authentication</a></li>
  <li><a href="#Authorization">Authorization</a>
    <ul>
      <li><a href="#Authorization%20Notes">Notes</a></li>
      <li><a href="#Authorization%20Examples">Examples</a></li>
    </ul>
  </li>
</ul>

<h2 id="Authentication">Authentication</h2>

<p>In standalone mode, Cantaloupe has built-in support for HTTP Basic authentication. To enable it, set the following keys in the configuration file:</p>

<figure class="highlight"><pre><code class="language-properties" data-lang="properties"><span class="py">auth.basic.enabled</span> <span class="p">=</span> <span class="s">true</span>
<span class="py">auth.basic.username</span> <span class="p">=</span> <span class="s">myusername</span>
<span class="py">auth.basic.secret</span> <span class="p">=</span> <span class="s">mypassword</span></code></pre></figure>

<p>When enabled, the entire website and all endpoints will be restricted.</p>

<hr>

<h2 id="Authorization">Authorization</h2>

<p>A custom <a href="delegate-script.html">delegate script</a> method can be used to implement authorization logic ranging from simple to complex. The image server will execute this method upon every image request and, depending on its return value, either authorize the request (by returning HTTP 200 OK), or not (by returning HTTP 403 Forbidden).</p>

<p>The delegate method in question is called <code>authorized?</code>. A skeleton with documented parameters and return values is present in the <span class="filename">delegates.rb.sample</span> file. By default, it just returns <code>true</code>, authorizing all requests.</p>

<h3 id="Authorization Notes">Notes</h3>

<ul>
  <li>The authorization method will be called on every image request and should therefore be written to be efficient.</li>
  <li>The authorization method will be called upon requests to all image endpoints, but not information endpoints.</li>
  <li>Implementations should not assume that the underlying source image actually exists, but they should not try to check for it regardless&mdash;the image server will handle that. (But, the check may occur after the delegate method is invoked.)</li>
</ul>

<h3 id="Authorization Examples">Examples</h3>

<ul>
  <li><a href="#example-1">Inspect the parameters</a></li>
  <li><a href="#example-2">Allow only requests for half-scale images or smaller</a></li>
  <li><a href="#example-3">Allow only requests for identifiers matching a certain pattern</a></li>
  <li><a href="#example-4">Allow only requests for images set as "public" in a MySQL database</a></li>
  <li><a href="#example-5">Allow only JPEG output</a></li>
  <li><a href="#example-6">Allow only certain user agents</a></li>
  <li><a href="#example-7">Allow only requests from clients that have an authorization cookie</a></li>
  <li><a href="#example-8">Restrict a region of an image</a></li>
</ul>

<h4 id="example-1">Inspect the parameters</h4>

<p>This method will print the parameters to the console.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Cantaloupe</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">authorized?</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">full_size</span><span class="p">,</span> <span class="n">operations</span><span class="p">,</span> <span class="n">resulting_size</span><span class="p">,</span>
                       <span class="n">output_format</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">request_headers</span><span class="p">,</span> <span class="n">client_ip</span><span class="p">,</span>
                       <span class="n">cookies</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">"identifier: </span><span class="si">#{</span><span class="n">identifier</span><span class="si">}</span><span class="s2">"</span>
    <span class="nb">puts</span> <span class="s2">"full_size: </span><span class="si">#{</span><span class="n">full_size</span><span class="si">}</span><span class="s2">"</span>
    <span class="nb">puts</span> <span class="s2">"operations: </span><span class="si">#{</span><span class="n">operations</span><span class="si">}</span><span class="s2">"</span>
    <span class="nb">puts</span> <span class="s2">"resulting_size: </span><span class="si">#{</span><span class="n">resulting_size</span><span class="si">}</span><span class="s2">"</span>
    <span class="nb">puts</span> <span class="s2">"output_format: </span><span class="si">#{</span><span class="n">output_format</span><span class="si">}</span><span class="s2">"</span>
    <span class="nb">puts</span> <span class="s2">"request_uri: </span><span class="si">#{</span><span class="n">request_uri</span><span class="si">}</span><span class="s2">"</span>
    <span class="nb">puts</span> <span class="s2">"request_headers: </span><span class="si">#{</span><span class="n">request_headers</span><span class="si">}</span><span class="s2">"</span>
    <span class="nb">puts</span> <span class="s2">"client_ip: </span><span class="si">#{</span><span class="n">client_ip</span><span class="si">}</span><span class="s2">"</span>
    <span class="nb">puts</span> <span class="s2">"cookies: </span><span class="si">#{</span><span class="n">cookies</span><span class="si">}</span><span class="s2">"</span>
    <span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<h4 id="example-2">Allow only requests for half-scale images or smaller</h4>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Cantaloupe</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">authorized?</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">full_size</span><span class="p">,</span> <span class="n">operations</span><span class="p">,</span> <span class="n">resulting_size</span><span class="p">,</span>
                       <span class="n">output_format</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">request_headers</span><span class="p">,</span> <span class="n">client_ip</span><span class="p">,</span>
                       <span class="n">cookies</span><span class="p">)</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">operations</span><span class="p">.</span><span class="nf">select</span><span class="p">{</span> <span class="o">|</span><span class="n">op</span><span class="o">|</span> <span class="n">op</span><span class="p">[</span><span class="s1">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'scale'</span> <span class="p">}.</span><span class="nf">first</span>
    <span class="k">if</span> <span class="n">scale</span>
      <span class="n">max_scale</span> <span class="o">=</span> <span class="mf">0.5</span>
      <span class="k">return</span> <span class="n">scale</span><span class="p">[</span><span class="s1">'width'</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">full_size</span><span class="p">[</span><span class="s1">'width'</span><span class="p">]</span> <span class="o">*</span> <span class="n">max_scale</span> <span class="n">and</span>
          <span class="n">scale</span><span class="p">[</span><span class="s1">'height'</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">full_size</span><span class="p">[</span><span class="s1">'height'</span><span class="p">]</span> <span class="o">*</span> <span class="n">max_scale</span>
    <span class="k">end</span>
    <span class="kp">false</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<h4 id="example-3">Allow only requests for identifiers matching a certain pattern</h4>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Cantaloupe</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">authorized?</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">full_size</span><span class="p">,</span> <span class="n">operations</span><span class="p">,</span> <span class="n">resulting_size</span><span class="p">,</span>
                       <span class="n">output_format</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">request_headers</span><span class="p">,</span> <span class="n">client_ip</span><span class="p">,</span>
                       <span class="n">cookies</span><span class="p">)</span>
    <span class="c1"># Allow only identifiers that don't include "_restricted"</span>
    <span class="k">return</span> <span class="o">!</span><span class="n">identifier</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="s1">'_restricted'</span><span class="p">)</span>
    <span class="c1"># Allow only identifiers that start with "_public"</span>
    <span class="k">return</span> <span class="n">identifier</span><span class="p">.</span><span class="nf">start_with?</span><span class="p">(</span><span class="s1">'public_'</span><span class="p">)</span>
    <span class="c1"># Allow only identifiers matching a regex</span>
    <span class="k">return</span> <span class="n">identifier</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sr">/^image[5-9][0-9]/</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<h4 id="example-4">Allow only requests for images set as "public" in a MySQL database</h4>

<p>(You will need to install the <a href="https://dev.mysql.com/downloads/connector/j/">MySQL JDBC driver</a> first.)</p>

<div class="alert alert-danger">Note: The parameters passed to <code>authorized?</code> are not guaranteed to be safe. <code>identifier</code>, for example, will be exactly as supplied in the URL. Always prefer prepared statements over string concatenation in order to reduce susceptibility to SQL injection attacks.</div>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Cantaloupe</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">authorized?</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">full_size</span><span class="p">,</span> <span class="n">operations</span><span class="p">,</span> <span class="n">resulting_size</span><span class="p">,</span>
                       <span class="n">output_format</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">request_headers</span><span class="p">,</span> <span class="n">client_ip</span><span class="p">,</span>
                       <span class="n">cookies</span><span class="p">)</span>
    <span class="nb">require</span> <span class="s2">"rubygems"</span>
    <span class="nb">require</span> <span class="s2">"jdbc/mysql"</span>
    <span class="nb">require</span> <span class="s2">"java"</span>

    <span class="n">authorized</span> <span class="o">=</span> <span class="kp">false</span>

    <span class="no">Java</span><span class="o">::</span><span class="n">com</span><span class="p">.</span><span class="nf">mysql</span><span class="p">.</span><span class="nf">jdbc</span><span class="o">.</span><span class="no">Driver</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">"jdbc:mysql://HOST/DATABASE"</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">java</span><span class="p">.</span><span class="nf">sql</span><span class="o">.</span><span class="no">DriverManager</span><span class="p">.</span><span class="nf">get_connection</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s2">"USERNAME"</span><span class="p">,</span> <span class="s2">"PASSWORD"</span><span class="p">)</span>
    <span class="n">stmt</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="nf">create_statement</span>

    <span class="k">begin</span>
      <span class="n">query</span> <span class="o">=</span> <span class="sx">%q{SELECT is_public
          FROM image
          WHERE identifier = ?
          LIMIT 1}</span>
      <span class="n">stmt</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="nf">prepare_statement</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
      <span class="n">stmt</span><span class="p">.</span><span class="nf">setString</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">identifier</span><span class="p">);</span>
      <span class="n">result_set</span> <span class="o">=</span> <span class="n">stmt</span><span class="p">.</span><span class="nf">execute_query</span>
      <span class="k">while</span> <span class="n">result_set</span><span class="p">.</span><span class="nf">next</span> <span class="k">do</span>
        <span class="n">authorized</span> <span class="o">=</span> <span class="n">result_set</span><span class="p">.</span><span class="nf">getBoolean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">ensure</span>
      <span class="n">stmt</span><span class="p">.</span><span class="nf">close</span>
      <span class="n">conn</span><span class="p">.</span><span class="nf">close</span>
    <span class="k">end</span>
    <span class="n">authorized</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<h4 id="example-5">Allow only JPEG output</h4>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Cantaloupe</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">authorized?</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">full_size</span><span class="p">,</span> <span class="n">operations</span><span class="p">,</span> <span class="n">resulting_size</span><span class="p">,</span>
                       <span class="n">output_format</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">request_headers</span><span class="p">,</span> <span class="n">client_ip</span><span class="p">,</span>
                       <span class="n">cookies</span><span class="p">)</span>
    <span class="n">output_format</span><span class="p">[</span><span class="s1">'media_type'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'image/jpeg'</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<h4 id="example-6">Allow only certain user agents</h4>

<div class="alert alert-warning">This is not foolproof&mdash;if a client knows what User-Agent you are checking for, they can spoof it.</div>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Cantaloupe</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">authorized?</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">full_size</span><span class="p">,</span> <span class="n">operations</span><span class="p">,</span> <span class="n">resulting_size</span><span class="p">,</span>
                       <span class="n">output_format</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">request_headers</span><span class="p">,</span> <span class="n">client_ip</span><span class="p">,</span>
                       <span class="n">cookies</span><span class="p">)</span>
    <span class="n">agent</span> <span class="o">=</span> <span class="n">request_headers</span><span class="p">.</span><span class="nf">select</span><span class="p">{</span> <span class="o">|</span><span class="n">h</span><span class="p">,</span> <span class="n">v</span><span class="o">|</span> <span class="n">h</span><span class="p">.</span><span class="nf">downcase</span> <span class="o">==</span> <span class="s1">'user-agent'</span> <span class="p">}.</span><span class="nf">first</span>
    <span class="n">agent</span> <span class="o">==</span> <span class="s1">'MyAllowedUserAgent/1.0'</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<h4 id="example-7">Allow only requests from clients that have an authorization cookie</h4>

<p>If you have an authorization service that sets a cookie, you can check for it. Cookies can't be shared across domains, but this could still work if you can set the cookie on a parent domain.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Cantaloupe</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">authorized?</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">full_size</span><span class="p">,</span> <span class="n">operations</span><span class="p">,</span> <span class="n">resulting_size</span><span class="p">,</span>
                       <span class="n">output_format</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">request_headers</span><span class="p">,</span> <span class="n">client_ip</span><span class="p">,</span>
                       <span class="n">cookies</span><span class="p">)</span>
    <span class="n">cookies</span><span class="p">.</span><span class="nf">select</span><span class="p">{</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span> <span class="n">c</span><span class="p">[</span><span class="s1">'authcookie'</span><span class="p">]</span> <span class="p">}.</span><span class="nf">any?</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<h4 id="example-8">Restrict a region of an image</h4>

<p>In this example, requests for images containing any part of the bottom right quadrant of the source image will be denied.</p>

<p>(Also see <a href="redaction.html">redaction.)</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">module</span> <span class="nn">Cantaloupe</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">authorized?</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">full_size</span><span class="p">,</span> <span class="n">operations</span><span class="p">,</span> <span class="n">resulting_size</span><span class="p">,</span>
                       <span class="n">output_format</span><span class="p">,</span> <span class="n">request_uri</span><span class="p">,</span> <span class="n">request_headers</span><span class="p">,</span> <span class="n">client_ip</span><span class="p">,</span>
                       <span class="n">cookies</span><span class="p">)</span>
    <span class="n">crop</span> <span class="o">=</span> <span class="n">operations</span><span class="p">.</span><span class="nf">select</span><span class="p">{</span> <span class="o">|</span><span class="n">op</span><span class="o">|</span> <span class="n">op</span><span class="p">[</span><span class="s1">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'crop'</span> <span class="p">}.</span><span class="nf">first</span>
    <span class="k">if</span> <span class="n">crop</span>
      <span class="n">max_x</span> <span class="o">=</span> <span class="n">full_size</span><span class="p">[</span><span class="s1">'width'</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
      <span class="n">max_y</span> <span class="o">=</span> <span class="n">full_size</span><span class="p">[</span><span class="s1">'height'</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
      <span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">crop</span><span class="p">[</span><span class="s1">'x'</span><span class="p">]</span> <span class="o">+</span> <span class="n">crop</span><span class="p">[</span><span class="s1">'width'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_x</span> <span class="n">and</span>
          <span class="n">crop</span><span class="p">[</span><span class="s1">'y'</span><span class="p">]</span> <span class="o">+</span> <span class="n">crop</span><span class="p">[</span><span class="s1">'height'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_y</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="kp">false</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

  </div>
</div>


      <footer>
</footer>

<script src="/cantaloupe/scripts/bootstrap.min.js"></script>
<script src="/cantaloupe/scripts/base.js"></script>

    </div>

  </body>

</html>
