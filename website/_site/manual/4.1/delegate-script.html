<!DOCTYPE html>
<html>

  <!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="High-performance dynamic image server in Java
">

  <title>
    Cantaloupe Image Server
    
      :: Delegate Script
    
  </title>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" href="/cantaloupe/css/syntax.css">
  <link rel="stylesheet" href="/cantaloupe/css/manual.css">

  <script src="/cantaloupe/scripts/jquery.min.js"></script>

</head>


  <body>

    <nav class="navbar navbar-expand-md navbar-dark bg-primary">
  <a class="navbar-brand" href="/cantaloupe/">
    <img alt="Cantaloupe" src="/cantaloupe/images/cantaloupe.png" width="40">
  </a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-items" aria-controls="navbar-items" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="navbar-items">
    <ul class="navbar-nav mr-auto">
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle  active " href="#" id="user-manual-dropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          User Manual
        </a>
        <div class="dropdown-menu" aria-labelledby="user-manual-dropdown">
          <a class="dropdown-item" href="/cantaloupe/manual/4.1/getting-started.html">4.1</a>
          <a class="dropdown-item" href="/cantaloupe/manual/4.0/getting-started.html">4.0</a>
          <a class="dropdown-item" href="/cantaloupe/manual/3.4/getting-started.html">3.4</a>
          <a class="dropdown-item" href="/cantaloupe/manual/3.3/getting-started.html">3.3</a>
          <a class="dropdown-item" href="/cantaloupe/manual/3.2/getting-started.html">3.2</a>
          <a class="dropdown-item" href="/cantaloupe/manual/3.1/getting-started.html">3.1</a>
          <a class="dropdown-item" href="/cantaloupe/manual/3.0/getting-started.html">3.0</a>
        </div>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="https://github.com/medusa-project/cantaloupe/">GitHub</a>
      </li>
    </ul>

    <ul class="navbar-nav ml-md-auto">
      <li class="nav-item">
        <a href="https://github.com/medusa-project/cantaloupe/releases.atom" title="Subscribe to Releases">
          <img width="22" height="22" src="/cantaloupe/images/feed.svg">
        </a>
      </li>
    </ul>
  </div>
</nav>


    <div class="container-fluid">
      <div class="row">
  <div class="col-sm-4 col-md-3 col-lg-2 d-print-none">
    <div class="card">
  <h5 class="card-header version">4.1</h5>
  <div class="list-group list-group-flush">
    <a class="list-group-item list-group-item-action " href="getting-started.html">Getting Started</a>

    <a class="list-group-item list-group-item-action " href="configuration.html">Configuration</a>

    <a class="list-group-item list-group-item-action " href="endpoints.html">Endpoints</a>

    <a class="list-group-item list-group-item-action " href="images.html">Images</a>

    <a class="list-group-item list-group-item-action " href="sources.html">Sources</a>

    <a class="list-group-item list-group-item-action " href="processors.html">Processors</a>

    <a class="list-group-item list-group-item-action " href="caching.html">Caching</a>

    <a class="list-group-item list-group-item-action " href="access-control.html">Access Control</a>

    <a class="list-group-item list-group-item-action  active " href="delegate-script.html">Delegate Script</a>

    <a class="list-group-item list-group-item-action " href="overlays.html">Overlays</a>

    <a class="list-group-item list-group-item-action " href="redaction.html">Redaction</a>

    <a class="list-group-item list-group-item-action " href="logging.html">Logging</a>

    <a class="list-group-item list-group-item-action " href="deployment.html">Deployment</a>

    <a class="list-group-item list-group-item-action " href="remote-management.html">Remote Management</a>
  </div>
</div>

  </div>
  <div class="col-sm-8 col-md-9 col-lg-10">
    <h1>Delegate Script</h1>

<ul class="toc">
  <li><a href="#Enabling">Enabling</a></li>
  <li><a href="#How%20It%20Works">How It Works</a></li>
  <li><a href="#Migrating">Migrating</a>
    <ul>
      <li><a href="#MigratingFrom4To41">From the 4.0 Script to the 4.1 Script</a></li>
      <li><a href="#MigratingFrom3To4">From the 3.x Script to the 4.0 Script</a></li>
    </ul>
  </li>
  <li><a href="#Gems">Gems</a></li>
  <li><a href="#Calling%20Java%20Code">Calling Java Code</a></li>
  <li><a href="#Improving%20Efficiency">Improving Efficiency</a>
    <ul>
      <li><a href="#Sharing%20Information">Sharing Information</a></li>
      <li><a href="#Connection Pooling">Connection Pooling</a></li>
      <li><a href="#Caching">Caching</a></li>
    </ul>
  </li>
  <li><a href="#Logging">Logging</a></li>
  <li><a href="#Testing%20Delegate%20Methods">Testing Delegate Methods</a></li>
</ul>

<p>The delegate script mechanism enables the use of custom code to customize the image server's behavior. It is designed for ease-of-use, with a simple interface and shallow learning curve. The language in which the code is written&mdash;Ruby&mdash;is easy to learn and work with, and only a small amount of code is needed to support most use cases.</p>

<p>Delegate methods are invoked by a JRuby interpreter bundled into the application. There is no need to install an external Ruby environment and no need to write Java or interact with internal API.</p>

<p>The JRuby interpreter is compatible with Ruby version 2.3.</p>

<hr>

<h2 id="Enabling">Enabling</h2>

<p>The delegate script is disabled by default. To enable it, follow these steps:</p>

<ol>
  <li>Copy the sample delegate script, <span class="filename">delegates.rb.sample</span>, included in the distribution, to <span class="filename">delegates.rb</span>.</li>
  <li>Reference it from the <code>delegate_script.pathname</code> configuration option.</li>
  <li>Set <code>delegate_script.enabled</code> to <code>true</code>.</li>
</ol>

<hr>

<h2 id="How It Works">How It Works</h2>

<p>The delegate script is a file containing a delegate class written in Ruby. The class is instantiated per-request, early in the request cycle, and disposed of at the end of the request cycle. At various points in the request cycle, its methods are called by the application to obtain custom information needed to service the request.</p>

<p>Before any other methods are called, the application will set the request context, which is a hash of request properties with perhaps some other helpful information mixed in. See the documentation of the <var>context</var> attribute (<code>attr_accessor :context</code>) in the sample delegate script file for information about the keys that may be present in the context hash.</p>

<p>You can also use a statement like <code>context.each{ |k,v| puts "#{k}: #{v}" }</code> in any method to print the context to the console.</p>

<p>The delegate script is reloaded whenever the script file changes. Be aware, though, that code that has already been loaded into the JRuby runtime cannot be unloaded. For example, when a class is changed, the new version will replace the old version; but constants within the class cannot be redefined.</p>

<div class="alert alert-danger">
  <i class="fa fa-warning"></i>
  Generally, neither the context, method arguments, nor return values are sanitized or validated. <strong>Be careful to write defensive, injection-safe code.</strong>
</div>

<hr>

<h2 id="Migrating">Migrating</h2>

<h3 id="MigratingFrom4To41">From the 4.0 Script to the 4.1 Script</h3>

<p>In version 4.1, the <code>authorized?()</code> and <code>redirect()</code> methods were merged into <code>authorize()</code>. See the documentation in the sample delegate script file for more information.</p>

<h3 id="MigratingFrom3To4">From the 3.x Script to the 4.0 Script</h3>

<p>See the <a href="../4.0/delegate-script.html#Migrating">4.0 user manual</a>.</p>

<hr>

<h2 id="Gems">Gems</h2>

<p>JRuby can use most Ruby gems, except those that have been built with native extensions. To import a gem, use a <code>require</code> statement:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">'mygem'</span></code></pre></figure>

<p><code>require</code> searches for gems based on the <code>$GEM_PATH</code> environment variable, falling back to <code>$GEM_HOME</code> if that is not defined. If JRuby fails to find your gem, check your <code>$GEM_PATH</code>. If you installed the gem using <code>gem install</code>, check the output of <code>gem env</code> (particularly the "gem paths" section) to see where it might have been installed, and ensure that those locations are present in <code>$GEM_PATH</code>.</p>

<hr>

<h2 id="Calling Java Code">Calling Java Code</h2>

<p>This example uses <a href="https://docs.oracle.com/javase/10/docs/api/java/net/URLConnection.html">URLConnection</a>, which is part of the JDK, to execute an HTTP request, as an alternative to other examples which use Ruby's Net::HTTP library.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">'java'</span>

<span class="n">java_import</span> <span class="n">java</span><span class="p">.</span><span class="nf">net</span><span class="o">.</span><span class="no">HttpURLConnection</span>
<span class="n">java_import</span> <span class="n">java</span><span class="p">.</span><span class="nf">net</span><span class="o">.</span><span class="no">URL</span>
<span class="n">java_import</span> <span class="n">java</span><span class="p">.</span><span class="nf">io</span><span class="o">.</span><span class="no">BufferedReader</span>
<span class="n">java_import</span> <span class="n">java</span><span class="p">.</span><span class="nf">io</span><span class="o">.</span><span class="no">FileNotFoundException</span>
<span class="n">java_import</span> <span class="n">java</span><span class="p">.</span><span class="nf">io</span><span class="o">.</span><span class="no">InputStreamReader</span>
<span class="n">java_import</span> <span class="n">java</span><span class="p">.</span><span class="nf">util</span><span class="p">.</span><span class="nf">stream</span><span class="o">.</span><span class="no">Collectors</span>

<span class="k">class</span> <span class="nc">CustomDelegate</span>
  <span class="k">def</span> <span class="nf">do_something</span>
    <span class="n">url</span> <span class="o">=</span> <span class="no">URL</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'http://example.org/'</span><span class="p">)</span>
    <span class="n">conn</span><span class="p">,</span> <span class="n">is</span><span class="p">,</span> <span class="n">reader</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="k">begin</span>
      <span class="n">conn</span> <span class="o">=</span> <span class="n">url</span><span class="p">.</span><span class="nf">openConnection</span>
      <span class="n">conn</span><span class="p">.</span><span class="nf">setRequestMethod</span> <span class="s1">'GET'</span>
      <span class="n">conn</span><span class="p">.</span><span class="nf">setReadTimeout</span> <span class="mi">30</span> <span class="o">*</span> <span class="mi">1000</span>
      <span class="n">conn</span><span class="p">.</span><span class="nf">connect</span>
      <span class="n">is</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="nf">getInputStream</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="nf">getResponseCode</span>

      <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">200</span>
        <span class="n">content_type</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="nf">getHeaderField</span> <span class="s1">'Content-Type'</span>
        <span class="k">if</span> <span class="n">content_type</span><span class="p">.</span><span class="nf">include?</span> <span class="s1">'text/plain'</span>
          <span class="n">reader</span> <span class="o">=</span> <span class="no">BufferedReader</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">InputStreamReader</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">is</span><span class="p">))</span>
          <span class="n">entity</span> <span class="o">=</span> <span class="n">reader</span><span class="p">.</span><span class="nf">lines</span><span class="p">.</span><span class="nf">collect</span><span class="p">(</span><span class="no">Collectors</span><span class="p">.</span><span class="nf">joining</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">))</span>
          <span class="nb">puts</span> <span class="n">entity</span>
        <span class="k">else</span>
          <span class="k">raise</span> <span class="no">IOError</span><span class="p">,</span> <span class="s2">"Unexpected Content-Type: </span><span class="si">#{</span><span class="n">content_type</span><span class="si">}</span><span class="s2">"</span>
        <span class="k">end</span>
      <span class="k">else</span>
        <span class="k">raise</span> <span class="no">IOError</span><span class="p">,</span> <span class="s2">"Unexpected status: </span><span class="si">#{</span><span class="n">status</span><span class="si">}</span><span class="s2">"</span>
      <span class="k">end</span>
    <span class="k">rescue</span> <span class="no">FileNotFoundException</span> <span class="o">=&gt;</span> <span class="n">e</span>
      <span class="k">return</span> <span class="kp">nil</span>
    <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
      <span class="no">Java</span><span class="o">::</span><span class="n">edu</span><span class="p">.</span><span class="nf">illinois</span><span class="p">.</span><span class="nf">library</span><span class="p">.</span><span class="nf">cantaloupe</span><span class="p">.</span><span class="nf">script</span><span class="o">.</span><span class="no">Logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
    <span class="k">ensure</span>
      <span class="n">reader</span><span class="o">&amp;</span><span class="p">.</span><span class="nf">close</span>
      <span class="n">is</span><span class="o">&amp;</span><span class="p">.</span><span class="nf">close</span>
      <span class="n">conn</span><span class="o">&amp;</span><span class="p">.</span><span class="nf">disconnect</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>See also: <a href="https://github.com/jruby/jruby/wiki/CallingJavaFromJRuby">CallingJavaFromJRuby</a></p>

<p>The whole JDK is at your fingertips, and there's nothing to stop you from using third-party JARs and accessing their API from JRuby. Be careful, though, as JARs may contain code that conflicts with the application's dependencies&mdash;different versions of the same library, for example.</p>

<hr>

<h2 id="Improving Efficiency">Improving Efficiency</h2>

<p>Several delegate methods will be called over the course of a single request, and making them as efficient as possible will improve response times. A couple of techniques for improving efficiency are:</p>

<h3 id="Sharing Information">Sharing Information</h3>

<p>Some methods may need to do similar work, which may be expensive. To avoid having to do it twice, a useful technique is to cache the result. So, rather than doing this:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">CustomDelegate</span>
  <span class="k">def</span> <span class="nf">method1</span><span class="p">(</span><span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="c1"># perform an expensive query and return the result</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">method2</span><span class="p">(</span><span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="c1"># perform an expensive query and return the result</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>You could do this:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">CustomDelegate</span>
  <span class="k">def</span> <span class="nf">method1</span><span class="p">(</span><span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">perform_expensive_query</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">method2</span><span class="p">(</span><span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">perform_expensive_query</span>
  <span class="k">end</span>

  <span class="c1"># Performs an expensive query only once, caching the result.</span>
  <span class="k">def</span> <span class="nf">perform_expensive_query</span>
    <span class="k">unless</span> <span class="vi">@result</span>
      <span class="c1"># perform the query</span>
      <span class="vi">@result</span> <span class="o">=</span> <span class="o">...</span> <span class="c1"># save the result in an instance variable</span>
    <span class="k">end</span>
    <span class="vi">@result</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<h3 id="Connection Pooling">Connection Pooling</h3>

<p>Most HTTP clients maintain an internal connection pool automatically, but JDBC adapters do not. Any code that accesses a database via JDBC should use a connection pool to improve performance. As of now, there is no &quot;official&quot; provision for this. Options include:</p>

<ol>
  <li>Use the built-in HikariCP pool used by JdbcSource and JdbcCache, noting that HikariCP is not part of the delegate script contract and may change or go away at some point (see <a href="https://github.com/medusa-project/cantaloupe/issues/221#issuecomment-398402952">here</a> for an example that may or may not work);</li>
  <li>Supply a third-party connection pool JAR;</li>
  <li>Write your own connection pool</li>
</ol>

<h3 id="Caching">Caching</h3>

<p>The <code>delegate_script.cache.enabled</code> option is available to cache the results of delegate method invocations. The cache is an in-memory least-recently-used (LRU) cache with infinite time-to-live and a maximum size auto-computed based on the maximum JVM heap size. When the limit is approached, the oldest invocations will be purged automatically.</p>

<p>The invocation cache can also be purged manually using the <a href="remote-management.html#HTTP%20API">HTTP API</a>.</p>

<p>The cache is not persisted. It will be lost when the application is stopped.</p>

<p>Cached invocations are <strong>not</strong> purged when the script file is auto-reloaded, such as in response to a change. If, while the application is running, you modify the script file in a way that would cause a return value to be different based on the same request context, you should either purge the invocation cache or restart.</p>

<hr>

<h2 id="Logging">Logging</h2>

<p>Delegate methods may access a logger that writes to the <a href="logging.html#Application%20Log">application log</a>:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">'java'</span>

<span class="n">logger</span> <span class="o">=</span> <span class="no">Java</span><span class="o">::</span><span class="n">edu</span><span class="p">.</span><span class="nf">illinois</span><span class="p">.</span><span class="nf">library</span><span class="p">.</span><span class="nf">cantaloupe</span><span class="p">.</span><span class="nf">script</span><span class="o">.</span><span class="no">Logger</span>
<span class="n">logger</span><span class="p">.</span><span class="nf">trace</span> <span class="s1">'Hello world'</span>
<span class="n">logger</span><span class="p">.</span><span class="nf">debug</span> <span class="s1">'Hello world'</span>
<span class="n">logger</span><span class="p">.</span><span class="nf">info</span> <span class="s1">'Hello world'</span>
<span class="n">logger</span><span class="p">.</span><span class="nf">warn</span> <span class="s1">'Hello world'</span>
<span class="n">logger</span><span class="p">.</span><span class="nf">error</span> <span class="s1">'Hello world'</span></code></pre></figure>

<p>Error stack traces may also be logged:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">'java'</span>

<span class="n">logger</span> <span class="o">=</span> <span class="no">Java</span><span class="o">::</span><span class="n">edu</span><span class="p">.</span><span class="nf">illinois</span><span class="p">.</span><span class="nf">library</span><span class="p">.</span><span class="nf">cantaloupe</span><span class="p">.</span><span class="nf">script</span><span class="o">.</span><span class="no">Logger</span>

<span class="k">begin</span>
  <span class="k">raise</span> <span class="s1">'Goodbye world'</span>
<span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">e</span>
  <span class="n">logger</span><span class="p">.</span><span class="nf">error</span> <span class="s2">"</span><span class="si">#{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">e</span>
<span class="k">end</span></code></pre></figure>

<hr>

<h2 id="Testing Delegate Methods">Testing Delegate Methods</h2>

<p>Delegate methods can be tested by creating an instance of the <code>CustomDelegate</code> class, setting its context to be similar to what the application would set it to, and calling a method:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># This file is named `test.rb`, in the same folder as `delegates.rb`</span>
<span class="nb">require</span> <span class="s1">'./delegates'</span>

<span class="n">obj</span> <span class="o">=</span> <span class="no">CustomDelegate</span><span class="p">.</span><span class="nf">new</span>
<span class="n">obj</span><span class="p">.</span><span class="nf">context</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">'identifier'</span> <span class="o">=&gt;</span> <span class="s1">'identifier-to-test'</span><span class="p">,</span>
  <span class="s1">'client_ip'</span> <span class="o">=&gt;</span> <span class="s1">'127.0.0.1'</span><span class="p">,</span>
  <span class="s1">'request_headers'</span> <span class="o">=&gt;</span> <span class="o">...</span>
<span class="p">}</span>

<span class="nb">puts</span> <span class="n">obj</span><span class="p">.</span><span class="nf">filesystemsource_pathname</span></code></pre></figure>

<p>This script can then be run on the command line with a command like: <code>ruby test.rb</code>.</p>

<p class="text-info"><i class="fa fa-info-circle"></i> The <span class="filename">ruby</span> command will normally invoke the standard ("MRI") Ruby interpreter, and not the JRuby interpreter. While they mostly work pretty similar, <strong>gems with platform-native extensions won't work in JRuby</strong>. Consider installing a standalone <a href="http://jruby.org">JRuby interpreter</a> and test with that instead. (Something like <a href="http://rvm.io/">RVM</a> can make it easier to switch between different versions of the Ruby interpreter.)</p>

  </div>
</div>


      <footer>
</footer>

<script src="/cantaloupe/scripts/bootstrap.min.js"></script>
<script src="/cantaloupe/scripts/base.js"></script>

    </div>

  </body>

</html>
